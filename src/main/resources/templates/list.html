{#include template.html}
{#body}
<div class="container">
    {#include logoheader.html/}
    <h2 class="font-weight-light my-3">Anmeldungen für Event am {event.startDate}: {registrations.size}</h2>
    <h3 class="font-weight-light my-3"><a href="{event.url}" target="_blank">{event.summary}</a></h3>
    <table class="table table-striped table-sm">
        <thead>
        <tr>
            <th>Lfd.Nr.</th>
            <th>Name</th>
            <th>E-Mail</th>
            <th>Stammtisch</th>
            <th>Warteliste</th>
            <th>Datum (UTC)</th>
            <th></th>
        </tr>
        </thead>
        <tbody>
        {#for reg in registrations}
            <tr id="{reg.id}">
                <td>
                    <input type="checkbox" value="{reg.id}" onclick="checkRegistration(this)"/>
                    {count}
                </td>
                <td>{reg.name}</td>
                <td><a href="mailto:{reg.email}">{reg.email}</a></td>
                <td>
                    {#if reg.pub}<img src="/webjars/bootstrap-icons/icons/check.svg" alt=""/>{/if}
                </td>
                <td>
                    {#if reg.waitlist}<img src="/webjars/bootstrap-icons/icons/hourglass-split.svg" alt=""/>{/if}
                </td>
                <td>{reg.formattedCreationDate}</td>
                <td>
                    <img src="/webjars/bootstrap-icons/icons/trash.svg" alt="" onclick="delReg('{reg.id}', '{reg.name}')" style="cursor: pointer"/>
                </td>
            </tr>
        {/for}
        </tbody>
    </table>
    <div class="my-3">
        <div class="d-flex justify-content-between">
            <button class="btn btn-sm btn-outline-info" data-toggle="collapse" data-target="#collapseWriteEmail">
                Schreibe E-Mail an Teilnehmer
            </button>
            <button class="btn btn-sm btn-outline-danger" data-toggle="collapse" data-target="#collapseEmails">
                Zeige Namen und E-Mails kopierbar
            </button>
            <button class="btn btn-sm btn-outline-primary" data-toggle="collapse" data-target="#collapseEventData">
                Zusätzliche Event-Daten
            </button>
        </div>
        <div class="collapse mt-3 mb-3" id="collapseWriteEmail">
            <h4>E-Mail an Teilnehmer</h4>
            <form onsubmit="return sendMail()">
                <div class="form-group">
                    <label for="webinarLink">Betreff</label>
                    <input type="text" class="form-control" id="subject" value="Einwahl zum Online-Vortrag der JUG Darmstadt heute Abend">
                </div>
                <div class="form-group">
                    <label for="message">Nachricht</label>
                    <textarea id="message" class="form-control" rows="8">{[Hallo {person.name}!

Du hast Dich für unseren heutigen Online-Vortrag angemeldet. Den Link zur Einwahl und weitere Informationen findest Du hier:

https://registration.jug-da.de/webinar/{eventId}

Bis heute Abend, wir freuen uns auf Dein Kommen. Im Anschluss an den Vortrag kannst Du übrigens gern noch bei unserem virtuellen Stammtisch mit plaudern oder einfach nur zuhören.

Viele Grüße
JUG DA]}</textarea>
                </div>
                <button type="submit" class="btn btn-info">Senden</button>
            </form>
        </div>
        <div class="collapse mt-3 mb-3" id="collapseEmails">
            <h4>Namen und E-Mails</h4>
            <div class="form-group">
                <label for="names">Namen</label>
                <textarea id="names" class="form-control" rows="5">{#for reg in registrations}{reg.name}
{/for}</textarea>
            </div>
            <div class="form-group">
                <label for="emails">E-Mails</label>
                <textarea id="emails" class="form-control" rows="5">{#for reg in registrations}{reg.email}, {/for}</textarea>
            </div>
        </div>
        <div class="collapse mt-3 mb-3" id="collapseEventData">
            <h4>Event-Infos</h4>
            <form onsubmit="return submitEventData()">
                <div class="form-group row">
                    <label for="webinarLink" class="col-2 col-form-label">Webinar-Link</label>
                    <div class="col-10">
                        <input type="text" class="form-control" id="webinarLink" value="{eventData.get('webinarLink')}">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Seichern</button>
            </form>
        </div>
    </div>
</div>
<script src="/webjars/jquery/jquery.min.js"></script>
<script src="/webjars/bootstrap/js/bootstrap.min.js"></script>
<script>
    function delReg(id, name) {
        if (confirm('Delete registration of ' + name + '?')) {
            console.log('deleting registration', id);
            $.ajax({
                url: '/delete?id=' + id,
                type: 'DELETE'
            }).done(function () {
                $('#' + id).remove();
            });
        }
    }
    function submitEventData() {
        const data = {
            webinarLink: $('#webinarLink').val()
        };
        $.ajax({
            url: '{eventId}/data',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
        }).done(() => {
            alert('Event-Daten gespeichert.');
        });
        return false;
    }
    const selectedRegistrations = [];
    function checkRegistration(elem) {
        if (elem.checked) {
            selectedRegistrations.push(elem.value);
        } else {
            selectedRegistrations.splice(selectedRegistrations.findIndex(e => e === elem.value), 1);
        }
    }
    function sendMail() {
        const data = {
            subject: $('#subject').val(),
            message: $('#message').val(),
            registrationIds: selectedRegistrations,
        };
        $.ajax({
            url: '{eventId}/message',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
        }).done(() => {
            alert('Nachricht an ' + selectedRegistrations.length + ' Teilnehmer gesendet.');
        });
        return false;
    }
</script>
{/body}
{/include}
